# Generate Julia wrappers for CFITSIO library

The Julia script to generate the wrapper code `cfitsio.jl` is in `generate_wrappers.jl`, it
uses the artifact `CFITSIO_jll` to parse the C header files `longnam.h` (for aliases) and
`fitsio.h` (for constants and function prototypes).


## Rationale

Owing to the number of functions in CFITSIO, it is necessary to generate wrapper code
automatically. This was previously done by a generator based on `Clang.jl` which parses all
the definitions in the header files of CFITSIO. This was done at each build of
`EasyFITS.jl`, this process can be quite long and generates a lot of unwanted code. Since
constant definitions and function prototypes in the header files of CFITSIO (`longnam.h` and
`fitsio.h`) have a quite simple structure, they can be parsed with a rather simple code
written from scratch and not based on `Clang.jl`. The objective is to speed-up the building
of `EasyFITS.jl` and produce wrapper code that is cleaner, shorter, and easier to check or
to amend for a human.

Compared to the old generator based on `Clang.jl`:

- the new generator is faster (a fraction of second to build);
- the new generator has no other dependencies than Julia and `CFITSIO_jll`;
- the new generator only wraps public functions of CFITSIO (those marked with the qualifier
  `CFITS_API` in `fitsio.h`) with their long names (those staring with `fits_`) in
  `longnam.h` and calling the correct C function (with a short name starting with `ff` or
  with the same long name) of the CFITSIO library;
- the new generator replaces `signed char` and `unsigned char` respectively by `Int8` and
  `UInt8` types which reflects CFITSIO assumptions;
- the new generator marks constant arguments by a `#= const =#` comment;
- the code generated by the new generator is portable, it should not depend on the
  architecture and may only depend on the CFITSIO version (whose API does not change very
  often).

In principle, `EasyFITS.jl` can use any of these wrapper codes.

## CFITSIO functions used in `EasyFITS.jl`

`EasyFITS.jl` only uses a subset of CFITIO library. Below is the list of CFITSIO functions
used in `EasyFITS.jl`:

- `CFITSIO.fits_close_file`
- `CFITSIO.fits_create_diskfile`
- `CFITSIO.fits_create_file`
- `CFITSIO.fits_create_img`
- `CFITSIO.fits_create_tbl`
- `CFITSIO.fits_delete_key`
- `CFITSIO.fits_delete_record`
- `CFITSIO.fits_flush_buffer`
- `CFITSIO.fits_get_colname`
- `CFITSIO.fits_get_colnum`
- `CFITSIO.fits_get_errstatus`
- `CFITSIO.fits_get_hdrspace`
- `CFITSIO.fits_get_hdu_num`
- `CFITSIO.fits_get_img_dim`
- `CFITSIO.fits_get_img_equivtype`
- `CFITSIO.fits_get_img_size`
- `CFITSIO.fits_get_img_type`
- `CFITSIO.fits_get_num_cols`
- `CFITSIO.fits_get_num_hdus`
- `CFITSIO.fits_get_num_rowsll`
- `CFITSIO.fits_get_version`
- `CFITSIO.fits_modify_comment`
- `CFITSIO.fits_movabs_hdu`
- `CFITSIO.fits_open_diskfile`
- `CFITSIO.fits_open_file`
- `CFITSIO.fits_read_card`
- `CFITSIO.fits_read_col_*`
- `CFITSIO.fits_read_colnull_*`
- `CFITSIO.fits_read_img`
- `CFITSIO.fits_read_imgnull`
- `CFITSIO.fits_read_record`
- `CFITSIO.fits_read_subset`
- `CFITSIO.fits_read_tdimll`
- `CFITSIO.fits_update_card`
- `CFITSIO.fits_write_col_*`
- `CFITSIO.fits_write_colnull_*`
- `CFITSIO.fits_write_comment`
- `CFITSIO.fits_write_date`
- `CFITSIO.fits_write_history`
- `CFITSIO.fits_write_img`
- `CFITSIO.fits_write_imgnull`
- `CFITSIO.fits_write_record`
- `CFITSIO.fits_write_subset`
- `CFITSIO.fits_write_tdim`
- `CFITSIO.fits_write_tdimll`

where `*` is one of the suffixes `str`, `log`, `byt`, `sbyt`, `usht`, `sht`, `ulng`, `lng`,
`ulnglng`, `lnglng`, `uint`, `int`, `flt`, `dbl`, `cmp`, and `dblcmp`.

## Check new wrapper code by comparing with old wrapper code

The generated `@ccall`s may be compared to the ones generated by the old generator based on
`Clang.jl`:

``` sh
make ccalls-old.jl ccalls-new.jl
diff ccalls-old.jl ccalls-new.jl
```

There should be no significant differences, except that only the public functions of CFITSIO
are in the new wrapper code and some functions requiring other C structures than `fitsfile`
(e.g. `FILE`) are omitted. These functions are not needed by `EasyFITS.jl`.

The functions in `fitsio.h` which are not interfaced are:
- `fits_read_wcstab` because of structure `wtbarr`;
- `fits_report_error` / `ffrprt` because of structure `FILE`;
- `fits_get_hduoff` / `ffghof` because of type `OFF_T`;
- `fits_write_hdu` / `ffwrhdu` because of structure `FILE`;
- `fits_iter_set_by_name` because of type `iteratorCol`;
- `fits_iter_set_by_num` because of type `iteratorCol`;
- `fits_iter_set_file` because of type `iteratorCol`;
- `fits_iter_set_colname` because of type `iteratorCol`;
- `fits_iter_set_colnum` because of type `iteratorCol`;
- `fits_iter_set_datatype` because of type `iteratorCol`;
- `fits_iter_set_iotype` because of type `iteratorCol`;
- `fits_iter_get_colnum` because of type `iteratorCol`;
- `fits_iter_get_datatype` because of type `iteratorCol`;
- `fits_iter_get_iotype` because of type `iteratorCol`;
- `fits_iter_get_tlmin` because of type `iteratorCol`;
- `fits_iter_get_tlmax` because of type `iteratorCol`;
- `fits_iter_get_repeat` because of type `iteratorCol`;
- `fits_iterate_data` / `ffiter` because of type `iteratorCol`;
- `fits_pixel_filter` because of type `PixelFilter`;
